<tool id="tinsel" name="Gather data and code" version="0.3.1">
  <description>for interactive analysis, visualization, and annotation with R and markdown</description>
  <version_command>tinsel.py --version</version_command>
  <requirements>
    <requirement type="package" version="3.1.1">R</requirement>
    <requirement type="package" version="1.12.4.2">pandoc</requirement>
  </requirements>
  <command interpreter="python">
    tinsel.py
    --config ${tinselfile}
    --source-out ${source}
    #if $notebook_out['value'] == "true"
    --notebook-out ${notebook}
    #end if
  </command>
  <inputs>
    <conditional name="notebook_out">
      <param name="value" type="select" label="Also create a magpie notebook?">
        <option value="true">Yes</option>
        <option value="false" selected="true">No</option>
      </param>
    </conditional>
    <repeat name="exports" title="Data/Code Export">
      <conditional name="source">
        <param name="type" type="select" label="Source type">
          <option value="data" selected="true">Data</option>
          <option value="code">Code</option>
        </param>
        <when value="data">
          <param name="input" type="data" label="Dataset"/>
          <param name="r_name" type="text" size="32" value="my.dataset" label="R variable name" help="From the R documentation for make.names, 'A syntactically valid name consists of letters, numbers and the dot or underline characters and starts with a letter or the dot not followed by a number.'"/>
        </when>
        <when value="code">
          <param name="input" type="data" format="ribbon" label="Ribbon"/>
        </when>
      </conditional>
    </repeat>
  </inputs>
  <outputs>
    <data format="Rmd" name="source" label="${tool.name} on ${on_string}: Rmd"/>
    <data format="magpie" name="notebook" label="${tool.name} on ${on_string}: notebook">
      <filter>(notebook_out['value'] == "true")</filter>
    </data>
  </outputs>
  <configfiles>
    <!--
         tinselfile aped from IPython's notebook format.
         http://ipython.org/ipython-doc/1/interactive/nbconvert.html
    -->
    <configfile name="tinselfile">
<![CDATA[
{
 "metadata": {
  "name": "tinselfile"
 },
 "nbformat": 3,
 "nbformat_minor": 0,
 "worksheets": [
  {
   "cells": [
#for $i, $s in enumerate($exports)
    {
  #if $s.source.type == 'code':
     "cell_type": "ribbon",
     "metadata": {},
  #else
     "cell_type": "dataset",
     "metadata": {
      "r_name": "${s.source.r_name}",
      "format": "${s.source.input.ext}"
     },
  #end if
     "input": "${s.source.input.file_name}"
  #if $i < len($exports) - 1 then '},' else '}'#
#end for
   ],
   "metadata": {}
  }
 ]
}

]]>
    </configfile>
  </configfiles>
  <help>

.. class:: infomark

**What it does**

``tinsel`` gathers together datasets and bits of R code called *ribbons* into an R markdown document.
It can also optionally generate a *notebook* for use with ``magpie``, a simple web-based R notebook application built with Shiny.

  </help>
</tool>
